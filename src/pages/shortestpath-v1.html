<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบบันทึกเส้นทางสั้นที่สุดระหว่างอาคาร</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');

    body { font-family: 'Kanit', sans-serif; }

    /* ส่วนวาดกราฟ */
    svg {
      width: 100%;
      height: 450px;
      background: #ffffff;
      border-radius: 12px;
    }
    .edge {
      stroke: #cbd5e1;
      stroke-width: 2;
      transition: stroke 0.15s ease, stroke-width 0.15s ease, opacity 0.15s ease;
    }
    .edge-label {
      font-size: 0.7rem;
      fill: #6b7280;
      pointer-events: none;
    }
    .node {
      fill: #0ea5e9;
      stroke: #e0f2fe;
      stroke-width: 3;
      transition: fill 0.15s ease, r 0.15s ease, stroke-width 0.15s ease;
    }
    .node-label {
      font-size: 0.75rem;
      fill: #111827;
      text-shadow: 0 1px 2px #ffffff;
    }
    .edge.highlight {
      stroke: #2563eb;
      stroke-width: 4;
      opacity: 0.95;
    }
    .node.highlight {
      fill: #f97316;
      stroke-width: 4;
      r: 9;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .legend-line,
    .legend-line-highlight {
      width: 30px;
      height: 3px;
      border-radius: 999px;
    }
    .legend-line { background: #cbd5e1; }
    .legend-line-highlight { background: #2563eb; }
    .legend-node,
    .legend-node-highlight {
      width: 11px;
      height: 11px;
      border-radius: 50%;
    }
    .legend-node {
      background: #0ea5e9;
      border: 2px solid #e0f2fe;
    }
    .legend-node-highlight {
      background: #f97316;
      border: 2px solid #fed7aa;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="max-w-7xl mx-auto px-4">
    <h1 class="text-3xl font-bold text-center text-indigo-700 mb-8">
      ระบบบันทึกเส้นทางสั้นที่สุดระหว่างอาคาร
    </h1>

    <!-- ฟอร์มเพิ่ม/แก้ไขข้อมูลเส้นทาง -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Building A -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">อาคาร A</label>
          <select id="buildingASelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">-- เลือกอาคาร A --</option>
            <option value="อาคาร 1 อาคารอำนวยการ|18.75877|99.01465">อาคาร 1 อาคารอำนวยการ</option>
            <option value="อาคาร 2 อาคารสารสนเทศ|18.75891|99.01526">อาคาร 2 อาคารสารสนเทศ</option>
            <option value="อาคาร 3 อาคารประถมศึกษา|18.75836|99.01513">อาคาร 3 อาคารประถมศึกษา</option>
            <option value="อาคาร 4 อาคารมัธยมศึกษาตอนต้น|18.75798|99.01551">อาคาร 4 อาคารมัธยมศึกษาตอนต้น</option>
            <option value="อาคาร 5 อาคารอนุบาล สระว่ายน้ำ โรงอาหาร|18.75817|99.01576">อาคาร 5 อาคารอนุบาล สระว่ายน้ำ โรงอาหาร</option>
            <option value="อาคาร 6 อาคารพลศึกษา ห้องสภานักเรียน|18.75739|99.01538">อาคาร 6 อาคารพลศึกษา ห้องสภานักเรียน</option>
            <option value="อาคาร 7 อาคารมัธยมศึกษาตอนปลาย ห้องสมุด|18.75759|99.01591">อาคาร 7 อาคารมัธยมศึกษาตอนปลาย ห้องสมุด</option>
            <option value="อื่นๆ">อื่นๆ (กรอกเอง)</option>
          </select>
          <input type="text" id="nameA" placeholder="ชื่ออาคาร A (ถ้าเลือกอื่นๆ)" class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-lg" readonly>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <input type="text" id="latA" placeholder="Latitude อาคาร A" class="px-4 py-2 border border-gray-300 rounded-lg" readonly>
            <input type="text" id="lngA" placeholder="Longitude อาคาร A" class="px-4 py-2 border border-gray-300 rounded-lg" readonly>
          </div>
        </div>

        <!-- Building B -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">อาคาร B</label>
          <select id="buildingBSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">-- เลือกอาคาร B --</option>
            <option value="อาคาร 1 อาคารอำนวยการ|18.75877|99.01465">อาคาร 1 อาคารอำนวยการ</option>
            <option value="อาคาร 2 อาคารสารสนเทศ|18.75891|99.01526">อาคาร 2 อาคารสารสนเทศ</option>
            <option value="อาคาร 3 อาคารประถมศึกษา|18.75836|99.01513">อาคาร 3 อาคารประถมศึกษา</option>
            <option value="อาคาร 4 อาคารมัธยมศึกษาตอนต้น|18.75798|99.01551">อาคาร 4 อาคารมัธยมศึกษาตอนต้น</option>
            <option value="อาคาร 5 อาคารอนุบาล สระว่ายน้ำ โรงอาหาร|18.75817|99.01576">อาคาร 5 อาคารอนุบาล สระว่ายน้ำ โรงอาหาร</option>
            <option value="อาคาร 6 อาคารพลศึกษา ห้องสภานักเรียน|18.75739|99.01538">อาคาร 6 อาคารพลศึกษา ห้องสภานักเรียน</option>
            <option value="อาคาร 7 อาคารมัธยมศึกษาตอนปลาย ห้องสมุด|18.75759|99.01591">อาคาร 7 อาคารมัธยมศึกษาตอนปลาย ห้องสมุด</option>
            <option value="อื่นๆ">อื่นๆ (กรอกเอง)</option>
          </select>
          <input type="text" id="nameB" placeholder="ชื่ออาคาร B (ถ้าเลือกอื่นๆ)" class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-lg" readonly>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <input type="text" id="latB" placeholder="Latitude อาคาร B" class="px-4 py-2 border border-gray-300 rounded-lg" readonly>
            <input type="text" id="lngB" placeholder="Longitude อาคาร B" class="px-4 py-2 border border-gray-300 rounded-lg" readonly>
          </div>
        </div>
      </div>

      <!-- Distance & Time -->
      <div class="grid grid-cols-2 gap-6 mt-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ระยะห่าง (เมตร)</label>
          <input type="number" id="distance" placeholder="เช่น 20" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" step="0.01" min="0">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">เวลาเดินทาง (นาที)</label>
          <input type="number" id="time" placeholder="เช่น 5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" min="0">
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex gap-4 mt-8 justify-center flex-wrap">
        <button id="addBtn" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
          เพิ่มข้อมูล
        </button>
        <button id="editBtn" class="px-8 py-3 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition" disabled>
          แก้ไข
        </button>
        <button id="deleteBtn" class="px-8 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition" disabled>
          ลบ
        </button>
        <button id="cancelBtn" class="hidden px-8 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">
          ยกเลิก
        </button>
      </div>
    </div>

    <!-- ตารางข้อมูลเส้นทาง -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-indigo-600 text-white">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">อาคาร A</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Lat A</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Lng A</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">อาคาร B</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Lat B</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Lng B</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ระยะห่าง (ม.)</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">เวลา (นาที)</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">จัดการ</th>
          </tr>
        </thead>
        <tbody id="dataTable" class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- ส่วนแสดงกราฟ + หาเส้นทางสั้นที่สุด -->
    <section class="bg-white rounded-lg shadow-lg p-8">
      <h2 class="text-2xl font-semibold text-indigo-700 mb-2">
        แสดงกราฟและหาเส้นทางที่สั้นที่สุด
      </h2>
      <p class="text-sm text-gray-500 mb-4">
        กราฟจะใช้ข้อมูลจากตารางด้านบนอัตโนมัติ สามารถเพิ่ม/แก้ไข/ลบข้อมูลเส้นทาง แล้วคำนวณเส้นทางสั้นที่สุดระหว่างอาคารใดก็ได้
      </p>

      <div class="flex flex-wrap gap-4 items-end mb-4">
        <div class="flex flex-col gap-1">
          <label for="startSelect" class="text-sm text-gray-700">จุดเริ่มต้น (อาคาร A)</label>
          <select id="startSelect" class="min-w-[220px] px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></select>
        </div>
        <div class="flex flex-col gap-1">
          <label for="endSelect" class="text-sm text-gray-700">จุดปลายทาง (อาคาร B)</label>
          <select id="endSelect" class="min-w-[220px] px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></select>
        </div>
        <div class="flex flex-col gap-1">
          <label for="weightType" class="text-sm text-gray-700">เกณฑ์ในการหาเส้นทาง</label>
          <select id="weightType" class="min-w-[180px] px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <option value="distance">ระยะทาง (เมตร)</option>
            <option value="time">เวลา (นาที)</option>
          </select>
        </div>
        <button id="runBtn" class="px-6 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-full hover:bg-indigo-700 shadow-md">
          คำนวณเส้นทางสั้นที่สุด
        </button>
      </div>

      <div id="result" class="text-sm bg-indigo-50 border border-indigo-100 rounded-lg px-4 py-3 mb-4">
        ยังไม่มีการคำนวณเส้นทาง เลือกจุดเริ่มต้นและปลายทางแล้วกดปุ่ม "คำนวณเส้นทางสั้นที่สุด"
      </div>

      <div class="border border-gray-200 rounded-lg p-4 bg-slate-50">
        <svg id="graph" viewBox="0 0 800 550"></svg>
        <div class="flex flex-wrap gap-4 mt-3">
          <div class="legend-item">
            <div class="legend-line"></div> เส้นเชื่อมปกติ
          </div>
          <div class="legend-item">
            <div class="legend-line-highlight"></div> เส้นทางที่สั้นที่สุด
          </div>
          <div class="legend-item">
            <div class="legend-node"></div> โหนด (อาคาร/จุดสำคัญ)
          </div>
          <div class="legend-item">
            <div class="legend-node-highlight"></div> โหนดอยู่ในเส้นทางที่สั้นที่สุด
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const buildings = {
      "อาคาร 1 อาคารอำนวยการ": ["18.75877", "99.01465"],
      "อาคาร 2 อาคารสารสนเทศ": ["18.75891", "99.01526"],
      "อาคาร 3 อาคารประถมศึกษา": ["18.75836", "99.01513"],
      "อาคาร 4 อาคารมัธยมศึกษาตอนต้น": ["18.75798", "99.01551"],
      "อาคาร 5 อาคารอนุบาล สระว่ายน้ำ โรงอาหาร": ["18.75817", "99.01576"],
      "อาคาร 6 อาคารพลศึกษา ห้องสภานักเรียน": ["18.75739", "99.01538"],
      "อาคาร 7 อาคารมัธยมศึกษาตอนปลาย ห้องสมุด": ["18.75759", "99.01591"]
    };

    let data = JSON.parse(localStorage.getItem("shortestPaths")) || [];
    let editingIndex = -1;

    const addBtn = document.getElementById("addBtn");
    const editBtn = document.getElementById("editBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    /* ---------- ส่วนตาราง + ฟอร์ม ---------- */

    function renderTable() {
      const tbody = document.getElementById("dataTable");
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 cursor-pointer";
        tr.onclick = () => selectRow(index);
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm">${item.nameA}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${item.latA}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${item.lngA}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${item.nameB}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${item.latB}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${item.lngB}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${item.distance}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${item.time}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
            <button onclick="event.stopPropagation(); selectRow(${index})" class="text-indigo-600 hover:text-indigo-900">เลือก</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function selectRow(index) {
      const item = data[index];
      document.getElementById("nameA").value = item.nameA;
      document.getElementById("latA").value = item.latA;
      document.getElementById("lngA").value = item.lngA;
      document.getElementById("nameB").value = item.nameB;
      document.getElementById("latB").value = item.latB;
      document.getElementById("lngB").value = item.lngB;
      document.getElementById("distance").value = item.distance;
      document.getElementById("time").value = item.time;

      // ตั้งค่า dropdown ให้ตรงเท่าที่หาเจอ
      setDropdown("buildingASelect", item.nameA, item.latA, item.lngA);
      setDropdown("buildingBSelect", item.nameB, item.latB, item.lngB);

      editingIndex = index;
      editBtn.disabled = false;
      deleteBtn.disabled = false;
      cancelBtn.classList.remove("hidden");
      addBtn.textContent = "บันทึกการแก้ไข";
      addBtn.className = "px-8 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition";

      // ตั้งค่าให้กราฟเลือก A,B ตาม row และพร้อมคำนวณ
      populatePathSelects();
      const startSelect = document.getElementById("startSelect");
      const endSelect = document.getElementById("endSelect");
      if (startSelect && endSelect) {
        startSelect.value = item.nameA;
        endSelect.value = item.nameB;
      }
    }

    function setDropdown(selectId, name, lat, lng) {
      const select = document.getElementById(selectId);
      const value = `${name}|${lat}|${lng}`;
      let found = false;

      Array.from(select.options).forEach(opt => {
        if (opt.value === value) found = true;
      });

      if (found) {
        select.value = value;
      } else {
        select.value = "อื่นๆ";
      }

      if (selectId === "buildingASelect") {
        document.getElementById("nameA").readOnly = found;
        document.getElementById("latA").readOnly = found;
        document.getElementById("lngA").readOnly = found;
      } else {
        document.getElementById("nameB").readOnly = found;
        document.getElementById("latB").readOnly = found;
        document.getElementById("lngB").readOnly = found;
      }
    }

    function clearForm() {
      document.getElementById("buildingASelect").value = "";
      document.getElementById("buildingBSelect").value = "";
      ["nameA","latA","lngA","nameB","latB","lngB","distance","time"].forEach(id => {
        document.getElementById(id).value = "";
        if (id.startsWith("name") || id.startsWith("lat") || id.startsWith("lng")) {
          document.getElementById(id).readOnly = true;
        }
      });
      editingIndex = -1;
      editBtn.disabled = true;
      deleteBtn.disabled = true;
      cancelBtn.classList.add("hidden");
      addBtn.textContent = "เพิ่มข้อมูล";
      addBtn.className = "px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition";
    }

    // Dropdown A
    document.getElementById("buildingASelect").addEventListener("change", function() {
      const val = this.value;
      if (val && val !== "อื่นๆ") {
        const [name, lat, lng] = val.split("|");
        document.getElementById("nameA").value = name;
        document.getElementById("latA").value = lat;
        document.getElementById("lngA").value = lng;
        document.getElementById("nameA").readOnly = true;
        document.getElementById("latA").readOnly = true;
        document.getElementById("lngA").readOnly = true;
      } else if (val === "อื่นๆ") {
        document.getElementById("nameA").readOnly = false;
        document.getElementById("latA").readOnly = false;
        document.getElementById("lngA").readOnly = false;
        document.getElementById("nameA").value = "";
        document.getElementById("latA").value = "";
        document.getElementById("lngA").value = "";
      }
    });

    // Dropdown B
    document.getElementById("buildingBSelect").addEventListener("change", function() {
      const val = this.value;
      if (val && val !== "อื่นๆ") {
        const [name, lat, lng] = val.split("|");
        document.getElementById("nameB").value = name;
        document.getElementById("latB").value = lat;
        document.getElementById("lngB").value = lng;
        document.getElementById("nameB").readOnly = true;
        document.getElementById("latB").readOnly = true;
        document.getElementById("lngB").readOnly = true;
      } else if (val === "อื่นๆ") {
        document.getElementById("nameB").readOnly = false;
        document.getElementById("latB").readOnly = false;
        document.getElementById("lngB").readOnly = false;
        document.getElementById("nameB").value = "";
        document.getElementById("latB").value = "";
        document.getElementById("lngB").value = "";
      }
    });

    // Add / Update
    addBtn.addEventListener("click", () => {
      const formData = {
        nameA: document.getElementById("nameA").value.trim(),
        latA: document.getElementById("latA").value.trim(),
        lngA: document.getElementById("lngA").value.trim(),
        nameB: document.getElementById("nameB").value.trim(),
        latB: document.getElementById("latB").value.trim(),
        lngB: document.getElementById("lngB").value.trim(),
        distance: document.getElementById("distance").value,
        time: document.getElementById("time").value
      };

      if (!formData.nameA || !formData.latA || !formData.lngA ||
          !formData.nameB || !formData.latB || !formData.lngB ||
          !formData.distance || !formData.time) {
        alert("กรุณากรอกข้อมูลให้ครบถ้วน");
        return;
      }

      if (editingIndex === -1) {
        data.push(formData);
      } else {
        data[editingIndex] = formData;
      }

      localStorage.setItem("shortestPaths", JSON.stringify(data));
      renderTable();
      clearForm();
      updateGraphAndSelectors();
    });

    // Delete
    deleteBtn.addEventListener("click", () => {
      if (editingIndex !== -1 && confirm("ยืนยันการลบข้อมูลนี้?")) {
        data.splice(editingIndex, 1);
        localStorage.setItem("shortestPaths", JSON.stringify(data));
        renderTable();
        clearForm();
        updateGraphAndSelectors();
      }
    });

    // Cancel
    cancelBtn.addEventListener("click", clearForm);

    /* ---------- ส่วนกราฟ + Shortest Path (Dijkstra) ---------- */

    let nodesGraph = {};
    let edgesGraph = [];
    let adjacency = {};

    function buildGraphFromData() {
      nodesGraph = {};
      edgesGraph = [];
      adjacency = {};

      data.forEach(item => {
        if (!item.nameA || !item.nameB) return;

        const a = item.nameA;
        const b = item.nameB;
        const latA = parseFloat(item.latA);
        const lngA = parseFloat(item.lngA);
        const latB = parseFloat(item.latB);
        const lngB = parseFloat(item.lngB);
        const distance = parseFloat(item.distance);
        const time = parseFloat(item.time);

        if (!nodesGraph[a]) nodesGraph[a] = { lat: latA, lng: lngA };
        if (!nodesGraph[b]) nodesGraph[b] = { lat: latB, lng: lngB };

        edgesGraph.push({ a, b, distance, time });
      });

      for (const name in nodesGraph) {
        adjacency[name] = [];
      }

      edgesGraph.forEach(e => {
        adjacency[e.a].push({ node: e.b, distance: e.distance, time: e.time });
        adjacency[e.b].push({ node: e.a, distance: e.distance, time: e.time });
      });
    }

    function computeLayout() {
      const padding = 40;
      const width = 800;
      const height = 550;

      let minLat = Infinity, maxLat = -Infinity;
      let minLng = Infinity, maxLng = -Infinity;

      for (const name in nodesGraph) {
        const p = nodesGraph[name];
        if (p.lat < minLat) minLat = p.lat;
        if (p.lat > maxLat) maxLat = p.lat;
        if (p.lng < minLng) minLng = p.lng;
        if (p.lng > maxLng) maxLng = p.lng;
      }

      const latRange = maxLat - minLat || 1;
      const lngRange = maxLng - minLng || 1;

      for (const name in nodesGraph) {
        const p = nodesGraph[name];
        const x = ((p.lng - minLng) / lngRange) * (width - 2 * padding) + padding;
        const y = height - (((p.lat - minLat) / latRange) * (height - 2 * padding) + padding);
        p.x = x;
        p.y = y;
      }
    }

    function drawGraph() {
      const svg = document.getElementById("graph");
      if (!svg) return;
      svg.innerHTML = "";

      // เส้นเชื่อม
      edgesGraph.forEach(e => {
        const p1 = nodesGraph[e.a];
        const p2 = nodesGraph[e.b];
        if (!p1 || !p2) return;

        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", p1.x);
        line.setAttribute("y1", p1.y);
        line.setAttribute("x2", p2.x);
        line.setAttribute("y2", p2.y);
        line.setAttribute("class", "edge");
        svg.appendChild(line);
        e.element = line;

        const midX = (p1.x + p2.x) / 2;
        const midY = (p1.y + p2.y) / 2;
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", midX);
        text.setAttribute("y", midY - 4);
        text.setAttribute("class", "edge-label");
        text.setAttribute("text-anchor", "middle");
        text.textContent = e.distance + " ม.";
        svg.appendChild(text);
      });

      // โหนด
      for (const name in nodesGraph) {
        const p = nodesGraph[name];

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", p.x);
        circle.setAttribute("cy", p.y);
        circle.setAttribute("r", 7);
        circle.setAttribute("class", "node");
        svg.appendChild(circle);
        p.element = circle;

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", p.x);
        label.setAttribute("y", p.y - 10);
        label.setAttribute("class", "node-label");
        label.setAttribute("text-anchor", "middle");
        label.textContent = name;
        svg.appendChild(label);
      }
    }

    function getUniqueNodeNames() {
      return Object.keys(nodesGraph).sort();
    }

    function populatePathSelects() {
      const startSelect = document.getElementById("startSelect");
      const endSelect = document.getElementById("endSelect");
      if (!startSelect || !endSelect) return;

      const names = getUniqueNodeNames();
      startSelect.innerHTML = "";
      endSelect.innerHTML = "";

      if (names.length === 0) {
        const opt = document.createElement("option");
        opt.textContent = "ยังไม่มีข้อมูล";
        opt.value = "";
        startSelect.appendChild(opt.cloneNode(true));
        endSelect.appendChild(opt.cloneNode(true));
        return;
      }

      names.forEach(name => {
        const o1 = document.createElement("option");
        o1.value = name;
        o1.textContent = name;
        startSelect.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = name;
        o2.textContent = name;
        endSelect.appendChild(o2);
      });

      // ค่าตั้งต้น
      if (!startSelect.value) startSelect.value = names[0];
      if (!endSelect.value) endSelect.value = names[names.length - 1];
    }

    function dijkstra(start, end, weightField) {
      const dist = {};
      const prev = {};
      const visited = new Set();
      const nodesList = Object.keys(adjacency);

      nodesList.forEach(n => dist[n] = Infinity);
      dist[start] = 0;

      while (true) {
        let u = null;
        let minDist = Infinity;

        for (const n of nodesList) {
          if (!visited.has(n) && dist[n] < minDist) {
            minDist = dist[n];
            u = n;
          }
        }

        if (u === null) break;
        if (u === end) break;

        visited.add(u);

        for (const edge of adjacency[u] || []) {
          const alt = dist[u] + edge[weightField];
          if (alt < dist[edge.node]) {
            dist[edge.node] = alt;
            prev[edge.node] = u;
          }
        }
      }

      if (dist[end] === Infinity) return { distance: Infinity, path: [] };

      const path = [];
      let curr = end;
      while (curr !== undefined) {
        path.unshift(curr);
        curr = prev[curr];
      }
      return { distance: dist[end], path };
    }

    function clearHighlights() {
      edgesGraph.forEach(e => {
        if (e.element) e.element.classList.remove("highlight");
      });
      for (const name in nodesGraph) {
        const p = nodesGraph[name];
        if (p.element) p.element.classList.remove("highlight");
      }
    }

    function highlightPath(path) {
      clearHighlights();

      path.forEach(name => {
        const p = nodesGraph[name];
        if (p && p.element) p.element.classList.add("highlight");
      });

      for (let i = 0; i < path.length - 1; i++) {
        const u = path[i];
        const v = path[i + 1];
        edgesGraph.forEach(e => {
          if ((e.a === u && e.b === v) || (e.a === v && e.b === u)) {
            if (e.element) e.element.classList.add("highlight");
          }
        });
      }
    }

    function runShortestPath() {
      const start = document.getElementById("startSelect").value;
      const end = document.getElementById("endSelect").value;
      const weightType = document.getElementById("weightType").value;
      const resultDiv = document.getElementById("result");

      if (!start || !end) {
        resultDiv.textContent = "ยังไม่มีข้อมูลกราฟ หรือยังไม่ได้เลือกจุดเริ่มต้น/ปลายทาง";
        return;
      }

      if (start === end) {
        clearHighlights();
        if (nodesGraph[start] && nodesGraph[start].element) {
          nodesGraph[start].element.classList.add("highlight");
        }
        resultDiv.innerHTML = `จุดเริ่มต้นและปลายทางเหมือนกัน: <strong>${start}</strong><br>ระยะทางรวม 0`;
        return;
      }

      const { distance, path } = dijkstra(start, end, weightType);

      if (distance === Infinity || path.length === 0) {
        clearHighlights();
        resultDiv.textContent = "ไม่พบเส้นทางระหว่างสองจุดนี้ (อาจยังไม่ได้เพิ่มเส้นทางในตาราง)";
        return;
      }

      highlightPath(path);
      const unit = weightType === "distance" ? "เมตร" : "นาที";
      const pathText = path.join(" → ");
      resultDiv.innerHTML =
        `เส้นทางที่สั้นที่สุดจาก <strong>${start}</strong> ไป <strong>${end}</strong><br>` +
        `เส้นทาง: ${pathText}<br>` +
        `ค่ารวมทั้งหมด: <strong>${distance} ${unit}</strong>`;
    }

    function updateGraphAndSelectors() {
      buildGraphFromData();
      const svg = document.getElementById("graph");
      const resultDiv = document.getElementById("result");

      if (Object.keys(nodesGraph).length === 0) {
        if (svg) svg.innerHTML = "";
        if (resultDiv) {
          resultDiv.textContent = "ยังไม่มีข้อมูลกราฟ กรุณาเพิ่มข้อมูลเส้นทางในตารางด้านบนก่อน";
        }
        populatePathSelects();
        return;
      }

      computeLayout();
      drawGraph();
      populatePathSelects();
    }

    const runBtn = document.getElementById("runBtn");
    runBtn.addEventListener("click", runShortestPath);

    // เริ่มต้นเมื่อโหลดหน้า
    renderTable();
    updateGraphAndSelectors();
  </script>
</body>
</html>
